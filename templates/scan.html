<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan H√†ng</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 10px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* √î nh·∫≠p li·ªáu l·ªõn, d·ªÖ nh√¨n */
        #barcodeInput { 
            width: 100%; 
            padding: 15px; 
            font-size: 20px; 
            box-sizing: border-box; 
            margin-bottom: 15px; 
            border: 2px solid #007bff; 
            border-radius: 5px; 
            outline: none;
        }
        #barcodeInput:focus { background-color: #e8f0fe; }

        .scan-list { margin-top: 10px; }
        .scan-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .scan-item:first-child { background-color: #d4edda; font-weight: bold; } /* Item m·ªõi nh·∫•t m√†u xanh */
        
        .btn-back { display: inline-block; margin-bottom: 15px; text-decoration: none; color: #666; font-size: 16px; padding: 5px 0; }
        
        /* Style cho c√°c √¥ ch·ªçn (Dropdown) */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group select { 
            width: 100%; padding: 12px; font-size: 16px; 
            border: 1px solid #ccc; border-radius: 5px; 
            background-color: #fff;
        }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 15px; top: 5px; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .modal-table th, .modal-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .modal-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <a href="/" class="btn-back" style="margin-bottom: 0;">‚Üê Quay l·∫°i Menu</a>
            <div style="display: flex; align-items: center;">
                <span style="margin-right: 10px; font-weight: 600; color: #333; font-size: 14px;">Xin ch√†o, {{ session.get('user') }}</span>
                <a href="/logout" style="text-decoration: none; color: #dc3545; font-weight: bold; font-size: 14px;">ƒêƒÉng xu·∫•t</a>
            </div>
        </div>
        
        <div id="selectionForm">
            <div class="form-group">
                <label for="jobType">Job No Type</label>
                <select id="jobType">
                    {% for type in job_types %}
                    <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="palletType">Lo·∫°i Pallet</label>
                <select id="palletType">
                    <option value="1.2">1.2m</option>
                    <option value="1.6">1.6m</option>
                    <option value="1.9">1.9m</option>
                    <option value="loose">Loose Carton</option>
                </select>
            </div>

            <div class="form-group">
                <label for="palletNo">S·ªë Pallet</label>
                <select id="palletNo">
                    {% for p in available_pallets %}
                    <option value="{{ p.no }}">{{ p.label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Header hi·ªÉn th·ªã th√¥ng tin khi ƒëang scan (·∫©n form ch·ªçn) -->
        <div id="scanHeader" style="display:none; margin-bottom: 15px; padding: 10px; background: #e8f0fe; border-radius: 5px; border: 1px solid #b8daff; color: #333;">
            <div><strong>Job:</strong> <span id="lblJobTypeDisplay"></span></div>
            <div style="margin-top:5px;"><strong>Pallet:</strong> <span id="lblPalletDisplay" style="font-size:1.2em; color:#007bff; font-weight:bold;"></span> (<span id="lblPalletTypeDisplay"></span>)</div>
            <button onclick="finishPallet()" style="margin-top: 10px; width: 100%; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">‚úÖ B√°o Xong Pallet</button>
        </div>

        <button id="btnToggleScan" style="margin-bottom: 15px; width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold;">B·∫Øt ƒë·∫ßu Scan</button>

        <button id="btnCamera" style="display:none; margin-bottom: 15px; width: 100%; padding: 12px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold;">üì∑ Scan b·∫±ng Camera</button>
        <select id="cameraSelect" style="display:none; width: 100%; padding: 10px; margin-bottom: 15px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px;"></select>
        <div id="reader" style="width: 100%; margin-bottom: 15px;"></div>

        <!-- autocomplete="off" ƒë·ªÉ tr√°nh b√†n ph√≠m ·∫£o che khu·∫•t ho·∫∑c g·ª£i √Ω c≈© -->
        <input type="text" id="barcodeInput" placeholder="Nh·∫•n 'B·∫Øt ƒë·∫ßu Scan' ƒë·ªÉ nh·∫≠p..."  autocomplete="off" disabled style="background-color: #e9ecef;">
        
        <div id="status" style="margin-bottom: 10px; font-size: 18px;">
            <div style="font-size: 0.9em; color: #333; margin-bottom: 5px; background: #eee; padding: 5px; border-radius: 4px;">
                Job: <span id="jobTotal" style="font-weight:bold">0</span> | 
                ƒê√£ xong: <span id="jobScanned" style="font-weight:bold; color:green">0</span> |
                C√≤n l·∫°i: <span id="jobRemain" style="font-weight:bold; color:red">0</span>
                <a href="javascript:void(0)" onclick="showRemainSkus()" style="margin-left: 5px; color: #007bff; text-decoration: none; font-weight: bold;">(Xem)</a>
                <div style="width: 100%; background-color: #ccc; border-radius: 4px; margin-top: 5px; height: 15px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background-color: #28a745; text-align: center; line-height: 15px; color: white; font-size: 10px; transition: width 0.3s;">0%</div>
                </div>
            </div>
            ƒê√£ scan : <span id="count">0</span> | Ch·ªù x·ª≠ l√Ω: <span id="queueCount" style="color: orange; font-weight: bold;">0</span><br>
            <strong>T·ªïng Pallet <span id="lblPallet"></span>: <span id="palletTotal" style="color: #007bff; font-size: 1.2em;">0</span></strong>
            <div id="palletDetails" style="font-size: 0.9em; color: #555; margin-top: 5px; padding: 5px; background: #f9f9f9; border-left: 3px solid #007bff; display: none; max-height: 200px; overflow-y: auto;"></div>
        </div>
        <div class="scan-list" id="scanList">
            <!-- K·∫øt qu·∫£ qu√©t s·∫Ω hi·ªán ·ªü ƒë√¢y -->
        </div>
        
        <!-- B·∫£ng l·ªãch s·ª≠ qu√©t -->
        <div style="margin-top: 20px;">
            <h3 style="font-size: 18px; margin-bottom: 10px; color: #333;">Danh s√°ch ƒë√£ scan (Theo Pallet)</h3>
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm Pallet ho·∫∑c SKU..." style="width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            <div style="overflow-x: auto; border: 1px solid #ddd; border-radius: 5px;">
                <table id="historyTable" style="width: 100%; border-collapse: collapse; font-size: 14px; background: white;">
                    <thead>
                        <tr style="background-color: #f8f9fa; border-bottom: 2px solid #ddd;">
                            <th style="padding: 10px; text-align: center; color: #555;">Pallet</th>
                            <th style="padding: 10px; text-align: left; color: #555;">SKU</th>
                            <th style="padding: 10px; text-align: center; color: #555;">S·ªë l∆∞·ª£ng (SSCC)</th>
                            <th style="padding: 10px; text-align: center; color: #555;">X√≥a</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for SKU Details -->
    <div id="skuModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle" style="margin-top: 0;">Chi ti·∫øt SKU</h3>
            <div id="modalBody">ƒêang t·∫£i...</div>
        </div>
    </div>

    <script>
        const input = document.getElementById('barcodeInput');
        const list = document.getElementById('scanList');
        const countSpan = document.getElementById('count');
        const jobTotalSpan = document.getElementById('jobTotal');
        const jobScannedSpan = document.getElementById('jobScanned');
        const jobRemainSpan = document.getElementById('jobRemain');
        const jobTypeSelect = document.getElementById('jobType');
        const palletSelect = document.getElementById('palletNo');
        const palletDetailsDiv = document.getElementById('palletDetails');
        const palletTypeSelect = document.getElementById('palletType');
        const btnToggleScan = document.getElementById('btnToggleScan');
        const btnCamera = document.getElementById('btnCamera');
        const cameraSelect = document.getElementById('cameraSelect');
        const selectionForm = document.getElementById('selectionForm');
        const scanHeader = document.getElementById('scanHeader');
        
        // Modal Logic
        const modal = document.getElementById('skuModal');
        function closeModal() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) closeModal(); }

        function showSkuDetails(sku) {
            const type = jobTypeSelect.value;
            document.getElementById('modalTitle').innerText = 'Chi ti·∫øt SKU: ' + sku;
            document.getElementById('modalBody').innerHTML = 'ƒêang t·∫£i...';
            modal.style.display = "block";

            fetch('/api/sku_details', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({job_type: type, sku: sku})
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    if (data.details.length === 0) {
                        document.getElementById('modalBody').innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu.</p>';
                        return;
                    }
                    let totalQty = 0;
                    let html = '<table class="modal-table"><thead><tr><th>Pallet</th><th>S·ªë l∆∞·ª£ng</th></tr></thead><tbody>';
                    data.details.forEach(d => {
                        totalQty += d.qty;
                        html += `<tr><td>${d.pallet}</td><td>${d.qty}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    
                    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ v·ªõi t·ªïng s·ªë l∆∞·ª£ng
                    document.getElementById('modalTitle').innerText = `Chi ti·∫øt SKU: ${sku} (T·ªïng: ${totalQty})`;
                    document.getElementById('modalBody').innerHTML = html;
                } else {
                    document.getElementById('modalBody').innerText = 'L·ªói: ' + data.message;
                }
            })
            .catch(e => document.getElementById('modalBody').innerText = 'L·ªói: ' + e);
        }

        function showRemainSkus() {
            const type = jobTypeSelect.value;
            document.getElementById('modalTitle').innerText = 'Danh s√°ch ch∆∞a Scan';
            document.getElementById('modalBody').innerHTML = 'ƒêang t·∫£i...';
            modal.style.display = "block";

            fetch('/api/get_remain_skus', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({job_type: type})
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    if (data.items.length === 0) {
                        document.getElementById('modalBody').innerHTML = '<p style="text-align:center; color:green; font-weight:bold;">ƒê√£ ho√†n th√†nh scan cho Job n√†y!</p>';
                        return;
                    }
                    let html = '<table class="modal-table"><thead><tr><th>SKU</th><th>C√≤n l·∫°i</th></tr></thead><tbody>';
                    data.items.forEach(item => {
                        html += `<tr><td>${item.sku}</td><td style="text-align:center; font-weight:bold;">${item.qty}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('modalBody').innerHTML = html;
                } else {
                    document.getElementById('modalBody').innerText = 'L·ªói: ' + data.message;
                }
            })
            .catch(e => document.getElementById('modalBody').innerText = 'L·ªói: ' + e);
        }

        // H√†m c·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
        function updateProgressBar(total, scanned) {
            let percent = 0;
            if (total > 0) {
                percent = Math.round((scanned / total) * 100);
            }
            const bar = document.getElementById('progressBar');
            bar.style.width = percent + '%';
            bar.innerText = percent + '%';
        }

        // H√†m l·∫•y th·ªëng k√™ Job
        function fetchJobStats() {
            const type = jobTypeSelect.value;
            fetch('/api/job_stats', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({job_type: type})
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    jobTotalSpan.innerText = data.total_sscc;
                    jobScannedSpan.innerText = data.scanned_sscc;
                    jobRemainSpan.innerText = data.remain_sscc;
                    updateProgressBar(data.total_sscc, data.scanned_sscc);
                }
            });
        }

        // H√†m l·∫•y chi ti·∫øt Pallet hi·ªán t·∫°i
        function fetchPalletDetails(arg) {
            const highlightSku = (typeof arg === 'string') ? arg : null;
            const type = jobTypeSelect.value;
            const pallet = palletSelect.value;
            
            document.getElementById('lblPallet').innerText = pallet;

            if (!pallet) {
                document.getElementById('palletTotal').innerText = '0';
                palletDetailsDiv.style.display = 'none';
                return;
            }

            fetch('/api/pallet_details', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({job_type: type, pallet_no: pallet})
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    document.getElementById('palletTotal').innerText = data.pallet_count;
                    
                    // Hi·ªÉn th·ªã danh s√°ch SKU
                    if (data.skus.length > 0) {
                        let tableHtml = '<table style="width:100%; border-collapse: collapse; margin-top:5px; background:white;">';
                        tableHtml += '<tr style="background:#eee;"><th style="border:1px solid #ddd; padding:8px; text-align:left;">SKU</th><th style="border:1px solid #ddd; padding:8px; text-align:center;">SL</th></tr>';
                        data.skus.forEach(s => {
                            const isHighlight = highlightSku && s.sku === highlightSku;
                            const bgStyle = isHighlight ? 'background-color: #d4edda;' : '';
                            const rowId = isHighlight ? 'id="highlightRow"' : '';
                            tableHtml += `<tr ${rowId} style="${bgStyle}"><td style="border:1px solid #ddd; padding:8px;">${s.sku}</td><td style="border:1px solid #ddd; padding:8px; text-align:center; font-weight:bold;">${s.qty}</td></tr>`;
                        });
                        tableHtml += '</table>';
                        palletDetailsDiv.innerHTML = tableHtml;
                        
                        // T·ª± ƒë·ªông cu·ªôn ƒë·∫øn d√≤ng v·ª´a c·∫≠p nh·∫≠t
                        if (highlightSku) {
                            const row = document.getElementById('highlightRow');
                            if (row) {
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    } else {
                        palletDetailsDiv.innerHTML = '<div style="padding:10px; text-align:center; color:#666;">Ch∆∞a c√≥ h√†ng trong pallet n√†y</div>';
                    }
                    palletDetailsDiv.style.display = 'block';
                }
            });
        }

        // H√†m c·∫≠p nh·∫≠t danh s√°ch Pallet kh·∫£ d·ª•ng (tr·ªëng)
        function fetchPallets() {
            const type = jobTypeSelect.value;
            fetch(`/api/get_pallets?job_type=${encodeURIComponent(type)}`)
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    palletSelect.innerHTML = '';
                    data.pallets.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.no;
                        opt.innerText = p.label;
                        palletSelect.appendChild(opt);
                    });
                    // C·∫≠p nh·∫≠t chi ti·∫øt cho pallet ƒë·∫ßu ti√™n (m·∫∑c ƒë·ªãnh)
                    if(data.pallets.length > 0) fetchPalletDetails();
                }
            });
        }

        // H√†m x√≥a scan
        function deleteScan(pallet, sku) {
            Swal.fire({
                title: 'X√°c nh·∫≠n x√≥a?',
                text: `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a SKU ${sku} kh·ªèi Pallet ${pallet}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'X√≥a',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    const type = jobTypeSelect.value;
                    fetch('/api/delete_scan', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({job_type: type, pallet: pallet, sku: sku})
                    })
                    .then(r => r.json())
                    .then(data => {
                        if(data.success) {
                            fetchJobStats();
                            fetchHistory();
                            fetchPallets(); 
                            Swal.fire('ƒê√£ x√≥a!', 'SKU ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi Pallet.', 'success');
                        } else {
                            Swal.fire('L·ªói', data.message, 'error');
                        }
                    });
                }
            });
        }

        // H√†m l·∫•y l·ªãch s·ª≠ qu√©t c·ªßa Job
        function fetchHistory() {
            const type = jobTypeSelect.value;
            fetch('/api/get_history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({job_type: type})
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    const tbody = document.querySelector('#historyTable tbody');
                    tbody.innerHTML = '';
                    data.history.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #eee';
                        tr.innerHTML = `
                            <td style="padding: 8px; text-align: center; font-weight: bold;">${item.pallet}</td>
                            <td style="padding: 8px;"><a href="javascript:void(0)" onclick="showSkuDetails('${item.sku}')" style="color: #007bff; text-decoration: underline;">${item.sku}</a></td>
                            <td style="padding: 8px; text-align: center; font-weight: bold;">${item.qty}</td>
                            <td style="padding: 8px; text-align: center;"><button onclick="deleteScan('${item.pallet}', '${item.sku}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">X√≥a</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
        }

        // G·ªçi khi ƒë·ªïi Job Type v√† khi m·ªõi v√†o trang
        jobTypeSelect.addEventListener('change', () => {
            fetchJobStats();
            fetchHistory();
            fetchPallets();
        });
        palletSelect.addEventListener('change', fetchPalletDetails);
        
        fetchJobStats();
        fetchHistory();
        fetchPalletDetails(); // G·ªçi l·∫ßn ƒë·∫ßu khi load trang

        let isScanning = false;
        // Thay th·∫ø isProcessing b·∫±ng h√†ng ƒë·ª£i
        let scanQueue = [];
        let isQueueRunning = false;
        let html5QrcodeScanner = null;
        
        // C·∫•u h√¨nh √¢m thanh (Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'success') {
                // Success: Beep cao, ng·∫Øn, trong tr·∫ªo
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(1200, now);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.15);
                oscillator.stop(now + 0.15);
            } 
            else if (type === 'not_found') {
                // Error: Not Found (Kh√¥ng c√≥ trong Masterdata) - √Çm thanh tr∆∞·ª£t xu·ªëng
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]); // Rung 3 l·∫ßn ng·∫Øn
                
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(600, now);
                oscillator.frequency.linearRampToValueAtTime(200, now + 0.4); // Tr∆∞·ª£t t·ª´ 600Hz xu·ªëng 200Hz
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.4);
                oscillator.stop(now + 0.4);
            } 
            else if (type === 'duplicate') {
                // Error: Duplicate/Logic (Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ch·ªù/ƒê√£ scan r·ªìi) - √Çm thanh tr·∫ßm, r√®
                if (navigator.vibrate) navigator.vibrate(500); // Rung d√†i 1 l·∫ßn
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(100, now); // T·∫ßn s·ªë th·∫•p 100Hz
                oscillator.start();
                gainNode.gain.setValueAtTime(1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.4);
                oscillator.stop(now + 0.4);
            } 
            else {
                // Generic Error
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(150, now);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.3);
                oscillator.stop(now + 0.3);
            }
        }

        btnToggleScan.addEventListener('click', () => {
            // K√≠ch ho·∫°t AudioContext khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c l·∫ßn ƒë·∫ßu
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            if (!isScanning) {
                // B·∫Øt ƒë·∫ßu scan
                if (!palletSelect.value) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Ch∆∞a ch·ªçn Pallet',
                        text: 'Vui l√≤ng ch·ªçn S·ªë Pallet tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu!',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                isScanning = true;
                
                // ·∫®n form ch·ªçn
                selectionForm.style.display = 'none';
                
                // Hi·ªán th√¥ng tin header
                document.getElementById('lblJobTypeDisplay').innerText = jobTypeSelect.value;
                document.getElementById('lblPalletDisplay').innerText = palletSelect.value;
                document.getElementById('lblPalletTypeDisplay').innerText = palletTypeSelect.options[palletTypeSelect.selectedIndex].text;
                scanHeader.style.display = 'block';
                
                // Enable input
                input.disabled = false;
                input.style.backgroundColor = "white";
                input.placeholder = "Qu√©t m√£ v·∫°ch...";
                input.focus();
                
                // Update button
                btnToggleScan.innerText = "D·ª´ng / ƒê·ªïi Pallet";
                btnToggleScan.style.backgroundColor = "#dc3545"; // Red
                btnCamera.style.display = "block"; // Hi·ªán n√∫t camera
            } else {
                // D·ª´ng scan
                isScanning = false;
                
                // Hi·ªán l·∫°i form ch·ªçn
                selectionForm.style.display = 'block';
                scanHeader.style.display = 'none';
                
                // Disable input
                input.disabled = true;
                input.style.backgroundColor = "#e9ecef";
                input.placeholder = "Nh·∫•n 'B·∫Øt ƒë·∫ßu Scan' ƒë·ªÉ nh·∫≠p...";
                
                // Update button
                btnToggleScan.innerText = "B·∫Øt ƒë·∫ßu Scan";
                btnToggleScan.style.backgroundColor = "#007bff"; // Blue
                btnCamera.style.display = "none"; // ·∫®n n√∫t camera
                
                // T·∫Øt camera n·∫øu ƒëang m·ªü
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.stop().then(() => {
                        html5QrcodeScanner.clear();
                        html5QrcodeScanner = null;
                    }).catch(err => console.log(err));
                    document.getElementById('reader').style.display = "none";
                    cameraSelect.style.display = "none";
                    btnCamera.innerText = "üì∑ Scan b·∫±ng Camera";
                }
            }
        });

        // X·ª≠ l√Ω n√∫t Camera
        btnCamera.addEventListener('click', () => {
            const readerDiv = document.getElementById('reader');
            if (html5QrcodeScanner) {
                // ƒêang b·∫≠t -> T·∫Øt
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                    readerDiv.style.display = "none";
                    cameraSelect.style.display = "none";
                    btnCamera.innerText = "üì∑ Scan b·∫±ng Camera";
                }).catch(err => console.log(err));
            } else {
                // ƒêang t·∫Øt -> B·∫≠t
                readerDiv.style.display = "block";
                
                // L·∫•y danh s√°ch camera
                Html5Qrcode.getCameras().then(devices => {
                    if (devices && devices.length) {
                        cameraSelect.innerHTML = '';
                        cameraSelect.style.display = 'block';
                        
                        devices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.id;
                            option.text = device.label || `Camera ${cameraSelect.options.length + 1}`;
                            cameraSelect.appendChild(option);
                        });

                        // M·∫∑c ƒë·ªãnh ∆∞u ti√™n t√¨m camera sau (back/environment)
                        let cameraId = devices[0].id;
                        const backCamera = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('sau') || d.label.toLowerCase().includes('environment'));
                        if (backCamera) {
                            cameraId = backCamera.id;
                        }
                        
                        cameraSelect.value = cameraId; // C·∫≠p nh·∫≠t dropdown hi·ªÉn th·ªã ƒë√∫ng camera ƒëang ch·ªçn
                        startCamera(cameraId);
                        
                        // S·ª± ki·ªán ƒë·ªïi camera
                        cameraSelect.onchange = () => {
                            if(html5QrcodeScanner) {
                                html5QrcodeScanner.stop().then(() => {
                                    startCamera(cameraSelect.value);
                                });
                            }
                        };
                        btnCamera.innerText = "‚ùå T·∫Øt Camera";
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói Camera',
                            text: 'Kh√¥ng t√¨m th·∫•y camera n√†o!',
                        });
                    }
                }).catch(err => {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói Camera',
                        text: "L·ªói truy c·∫≠p camera: " + err,
                    });
                });
            }
        });

        let lastCamCode = null;
        let lastCamTime = 0;

        function startCamera(cameraId) {
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                cameraId, 
                { fps: 20, qrbox: 250 }, // TƒÉng FPS l√™n 20 ƒë·ªÉ b·∫Øt h√¨nh nhanh h∆°n
                (decodedText, decodedResult) => {
                    // Debounce cho Camera: Tr√°nh qu√©t l·∫°i m√£ c≈© trong 1.5 gi√¢y
                    const now = Date.now();
                    if (decodedText === lastCamCode && (now - lastCamTime < 1500)) {
                        return;
                    }
                    lastCamCode = decodedText;
                    lastCamTime = now;
                    handleScan(decodedText);
                },
                (errorMessage) => {
                    // ignore
                }
            ).catch(err => {
                console.log("Start failed", err);
            });
        }

        let scanCount = 0;

        // Gi·ªØ focus v√†o √¥ input b·∫•t k·ªÉ click ƒëi ƒë√¢u (Ch·∫ø ƒë·ªô Kiosk/Scanner)
        // Ch·ªâ focus khi modal kh√¥ng m·ªü
        document.addEventListener('click', (e) => {
            if (isScanning && modal.style.display !== "block" && e.target !== input && !e.target.closest('.modal-content') && e.target !== btnToggleScan) {
                input.focus();
            }
        });

        // Ch·ª©c nƒÉng t√¨m ki·∫øm trong b·∫£ng l·ªãch s·ª≠
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const filter = this.value.toUpperCase();
            const table = document.getElementById('historyTable');
            const tr = table.getElementsByTagName('tr');

            // B·∫Øt ƒë·∫ßu t·ª´ 1 ƒë·ªÉ b·ªè qua d√≤ng ti√™u ƒë·ªÅ (thead)
            for (let i = 1; i < tr.length; i++) {
                const tdPallet = tr[i].getElementsByTagName('td')[0];
                const tdSku = tr[i].getElementsByTagName('td')[1];
                if (tdPallet || tdSku) {
                    const txtPallet = tdPallet.textContent || tdPallet.innerText;
                    const txtSku = tdSku.textContent || tdSku.innerText;
                    if (txtPallet.toUpperCase().indexOf(filter) > -1 || txtSku.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        });

        // X·ª≠ l√Ω khi m√°y qu√©t g·ª≠i ph√≠m Enter
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleScan(this.value.trim());
                this.value = '';
            }
        });

        // H√†m x·ª≠ l√Ω scan chung (cho c·∫£ Input v√† Camera)
        function handleScan(code) {
            // ƒê·∫©y v√†o h√†ng ƒë·ª£i ƒë·ªÉ x·ª≠ l√Ω, kh√¥ng ch·∫∑n ng∆∞·ªùi d√πng qu√©t ti·∫øp
            if (code) {
                scanQueue.push(code);
                document.getElementById('queueCount').innerText = scanQueue.length;
                processScanQueue();
            }
        }

        function processScanQueue() {
            if (isQueueRunning || scanQueue.length === 0) return;

            isQueueRunning = true;
            const code = scanQueue.shift();
            document.getElementById('queueCount').innerText = scanQueue.length;
            
            const jobType = document.getElementById('jobType').value;
            const palletNo = document.getElementById('palletNo').value;
            const palletType = document.getElementById('palletType').value;
            
            // C·∫≠p nh·∫≠t s·ªë pallet ƒëang hi·ªÉn th·ªã
            document.getElementById('lblPallet').innerText = palletNo;
                // G·ª≠i d·ªØ li·ªáu l√™n server x·ª≠ l√Ω
                fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ barcode: code, job_type: jobType, pallet_no: palletNo, pallet_type: palletType })
                })
                .then(response => response.json())
                .then(data => {
                    const item = document.createElement('div');
                    item.className = 'scan-item';
                    
                    if (data.success) {
                        playSound('success');
                        scanCount++;
                        countSpan.innerText = scanCount;
                        
                        // C·∫≠p nh·∫≠t t·ªïng s·ªë l∆∞·ª£ng pallet t·ª´ server tr·∫£ v·ªÅ
                        if (data.pallet_count !== undefined) {
                            document.getElementById('palletTotal').innerText = data.pallet_count;
                        }
                        
                        // C·∫≠p nh·∫≠t th·ªëng k√™ Job
                        if (data.total_sscc !== undefined) {
                            jobTotalSpan.innerText = data.total_sscc;
                            jobScannedSpan.innerText = data.scanned_sscc;
                            jobRemainSpan.innerText = data.remain_sscc;
                            updateProgressBar(data.total_sscc, data.scanned_sscc);
                        }
                        
                        // C·∫≠p nh·∫≠t l·∫°i b·∫£ng l·ªãch s·ª≠
                        // fetchHistory(); // T·∫°m t·∫Øt ƒë·ªÉ gi·∫£m t·∫£i server v√† tƒÉng t·ªëc ƒë·ªô scan
                        fetchPalletDetails(data.sku); // C·∫≠p nh·∫≠t l·∫°i chi ti·∫øt pallet v·ª´a qu√©t

                        item.innerHTML = `<span>${data.sku}</span> <span style="color:green; font-weight:bold">OK</span>`;
                        item.style.backgroundColor = '#d4edda';
                    } else {
                        // Ph√¢n lo·∫°i l·ªói ƒë·ªÉ ph√°t √¢m thanh
                        const msg = data.message.toLowerCase();
                        if (msg.includes('masterdata') || msg.includes('prefix')) {
                            playSound('not_found'); // L·ªói kh√¥ng t·ªìn t·∫°i m√£
                        } else if (msg.includes('kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ch·ªù') || msg.includes('duplicate')) {
                            playSound('duplicate'); // L·ªói ƒë√£ scan r·ªìi ho·∫∑c kh√¥ng c√≥ trong job
                        } else {
                            playSound('error'); // L·ªói chung
                        }

                        item.innerHTML = `<span>${code}</span> <span style="color:red; font-weight:bold">${data.message}</span>`;
                        item.style.backgroundColor = '#f8d7da';
                    }
                    list.prepend(item);
                })
                .catch(err => {
                    playSound('error');
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói k·∫øt n·ªëi',
                        text: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!',
                    });
                })
                .finally(() => {
                    isQueueRunning = false;
                    processScanQueue(); // X·ª≠ l√Ω ti·∫øp m√£ ti·∫øp theo trong h√†ng ƒë·ª£i
                });
        }

        function finishPallet() {
            const jobType = document.getElementById('jobType').value;
            const palletNo = document.getElementById('palletNo').value;
            const palletType = document.getElementById('palletType').value;

            Swal.fire({
                title: 'Ho√†n th√†nh Pallet?',
                text: `X√°c nh·∫≠n ho√†n th√†nh Pallet ${palletNo}? Th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn b·ªô ph·∫≠n in.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ƒê·ªìng √Ω',
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/api/finish_pallet', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({job_type: jobType, pallet_no: palletNo, pallet_type: palletType})
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) Swal.fire('Th√†nh c√¥ng', data.message, 'success');
                        else Swal.fire('L·ªói', data.message, 'error');
                    })
                    .catch(e => Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi: ' + e, 'error'));
                }
            });
        }
    </script>
</body>
</html>